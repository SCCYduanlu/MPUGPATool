<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>MPU GPA Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #74ebd5, #acb6e5);
            text-align: center;
            padding: 20px;
        }
        h1 {
            color: white;
        }

        #progress-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px;
            width: 100%; /* ç¡®ä¿å®½åº¦é€‚åº”å±å¹• */
            max-width: 600px; /* æœ€å¤§å®½åº¦é™åˆ¶ï¼Œé¿å…åœ¨éå¸¸å¤§çš„å±å¹•ä¸Šè¿‡å®½ */
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
            text-align: center;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            box-sizing: border-box; /* ç¡®ä¿è¾¹è·ä¸ä¼šè¶…å‡ºå±å¹• */
        }
        
        @media (max-width: 768px) {
            #progress-container {
                width: 90%; /* åœ¨å°å±è®¾å¤‡ä¸Šï¼Œå®¹å™¨å®½åº¦ä¸º 90% */
                max-width: 95%; /* æœ€å¤§å®½åº¦ä¸º 95% */
            }
        }
        
        @media (max-width: 480px) {
            #progress-container {
                width: 95%; /* åœ¨æ‰‹æœºè®¾å¤‡ä¸Šï¼Œå®¹å™¨å®½åº¦ä¸º 95% */
                max-width: 100%; /* æœ€å¤§å®½åº¦ä¸º 100% */
            }
        }

        #progress-bar {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
            height: 12px;
            margin-top: 10px;
        }
        #progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #ff9966, #ff5e62);
            transition: width 0.5s ease-in-out;
        }
        #progress.error {
            background: red !important;
        }
        #loading-text {
            color: #333;
            font-weight: bold;
            margin-top: 10px;
        }

        /* æ·»åŠ è¿™ä¸ªæ ·å¼æ¥æ”¯æŒè¡¨æ ¼çš„æ¨ªå‘æ»šåŠ¨ */
        #gpa-table-wrapper {
            overflow-x: auto;
            margin: 20px 0;
            width: 100%;
        }

        #gpa-table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            overflow: hidden;
        }

        #gpa-table th, #gpa-table td {
            border: 1px solid #ddd;
            padding: 10px;
            white-space: nowrap; /* é˜²æ­¢å†…å®¹æ¢è¡Œï¼Œå¼ºåˆ¶æ¨ªå‘æ˜¾ç¤º */
        }

        #gpa-table th {
            background: #007bff;
            color: white;
        }

        #gpa-summary {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            width: 60%;
            margin: auto;
            text-align: center;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }

        #gpa-summary h2 {
            font-size: 22px;
            color: #007bff;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .gpa-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            text-align: left;
            padding: 10px 0;
        }

        .gpa-box {
            flex: 1 1 45%;
            background: rgba(230, 230, 230, 0.8);
            padding: 12px;
            border-radius: 10px;
            margin: 8px;
            font-size: 16px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .highlight-box {
            background: linear-gradient(to right, #ff9966, #ff5e62);
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            font-size: 18px;
        }

        #required-gpa-list {
            list-style: none;
            padding: 0;
        }

        .required-gpa-item {
            font-size: 16px;
            font-weight: bold;
            padding: 8px;
            margin: 5px;
            border-radius: 8px;
        }

        .gpa-reachable {
            color: green;
        }

        .gpa-unreachable {
            color: red;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            #gpa-summary {
                width: 90%;
            }

            .gpa-box {
                flex: 1 1 100%;
                margin: 5px;
            }

            #gpa-table th, #gpa-table td {
                font-size: 12px;
                padding: 8px;
            }

            #progress-container {
                width: 95%;
            }

            .highlight-box {
                font-size: 16px;
                padding: 10px;
            }
        }

        /* å¢åŠ æ”¯æŒå°å±å¹•çš„æ”¹è¿› */
        @media (max-width: 480px) {
            #gpa-summary h2 {
                font-size: 18px;
            }

            .gpa-box {
                font-size: 14px;
            }

            #progress-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>MPU GPA Tool</h1>

    <!-- è¿›åº¦æ¡† -->
    <div id="progress-container">
        <p id="loading-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
        <div id="progress-bar">
            <div id="progress"></div>
        </div>
    </div>

    <!-- GPA è¯¦ç»†è¡¨æ ¼ åŒ…è£¹åœ¨ä¸€ä¸ªå¯ä»¥æ»šåŠ¨çš„å®¹å™¨å†… -->
    <div id="gpa-table-wrapper">
        <table id="gpa-table">
            <thead>
                <tr>
                    <th>å­¦å¹´</th>
                    <th>å­¦æœŸ</th>
                    <th>è¯¾ç¨‹ä»£ç </th>
                    <th>è¯¾èŠ‚ä»£ç </th>
                    <th>è¯¾ç¨‹åç§° (è‹±)</th>
                    <th>è¯¾ç¨‹åç§° (ä¸­)</th>
                    <th>æˆç»©</th>
                    <th>GPA</th>
                    <th>å­¦åˆ†</th>
                </tr>
            </thead>
            <tbody id="gpa-table-body"></tbody>
        </table>
    </div>

    <!-- GPA æ€»è§ˆéƒ¨åˆ† -->
    <div id="gpa-summary">
        <h2>ğŸ“Š GPA è®¡ç®—ç»“æœ</h2>
        <div class="gpa-container">
            <div class="gpa-box"><strong>ä¸“ä¸šä»£å·:</strong> <span id="major-code"></span></div>
            <div class="gpa-box"><strong>ä¸“ä¸šåç§°:</strong> <span id="major-name"></span></div>
            <div class="gpa-box"><strong>æ€»å­¦åˆ†:</strong> <span id="total-credits"></span></div>
            <div class="gpa-box"><strong>å·²ä¿®å­¦åˆ†:</strong> <span id="completed-credits"></span></div>
            <div class="gpa-box"><strong>æœªä¿®å­¦åˆ†:</strong> <span id="remaining-credits"></span></div>
        </div>
    
        <div class="highlight-box">
            ğŸ“ˆ å½“å‰ GPA: <span id="final-gpa"></span>
        </div>
    
        <h3>ğŸ¯ ç›®æ ‡ GPA è®¡ç®—</h3>
        <ul id="required-gpa-list"></ul>
    
        <!-- GPA æŠ˜çº¿å›¾ -->
        <div class="gpa-chart">
            <br>
            <h3>ğŸ“Š å·²è¯»ç§‘ç›® GPA æ›²çº¿</h3>
            <canvas id="gpa-line-chart"></canvas>
        </div>
    </div>



    <script>
        function fetchGPA() {
            const progressContainer = document.getElementById("progress-container");
            const progress = document.getElementById("progress");
            const loadingText = document.getElementById("loading-text");
            const gpaTable = document.getElementById("gpa-table");
            const gpaTableBody = document.getElementById("gpa-table-body");
            const gpaSummary = document.getElementById("gpa-summary");
            let gpaSummaryData = null;
            let gpaData = [];
            let progressValue = 0;
            let hasReceivedValidData = false; // æ ‡å¿—å˜é‡ï¼Œè·Ÿè¸ªæ˜¯å¦æ”¶åˆ°æœ‰æ•ˆæ•°æ®
            let lastNonJsonMessage = ""; // ç”¨äºå­˜å‚¨æœ€åä¸€æ¡é JSON æ•°æ®
        
            fetch("/fetch_gpa/stream/")
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
        
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                // å¦‚æœæ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆæ•°æ®ï¼Œåˆ™æ›´æ–°è¿›åº¦æ¡ä¸º 100% å¹¶æ˜¾ç¤ºé”™è¯¯
                                if (!hasReceivedValidData) {
                                    console.error("âŒ æ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆçš„ GPA æ•°æ®ï¼");
                                    loadingText.innerText = lastNonJsonMessage || "âŒ æ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆçš„ GPA æ•°æ®ï¼Œè¯·é‡è¯•ï¼"; // æ˜¾ç¤ºæœ€åä¸€æ¡é JSON æ•°æ®
                                    progress.style.width = "100%";  // ç›´æ¥è·³åˆ° 100%
                                    progress.classList.add("error"); // æ˜¾ç¤ºé”™è¯¯æ ·å¼
                                    progressContainer.style.display = "block"; // ç¡®ä¿æ˜¾ç¤ºè¿›åº¦æ¡
                                } else {
                                    // æµè¯»å–å®Œæˆï¼Œéšè—è¿›åº¦æ¡ï¼Œæ˜¾ç¤º GPA æ•°æ®è¡¨æ ¼
                                    progressContainer.style.display = "none"; 
                                    gpaTable.style.display = "table";
        
                                    if (gpaSummaryData) {
                                        gpaSummary.style.display = "block"; 
                                        renderGpaSummary(gpaSummaryData);
                                    } else {
                                        console.error("âŒ GPA æ€»è§ˆæ•°æ®ä¸¢å¤±ï¼");
                                        loadingText.innerText = "âŒ GPA æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡è¯•ï¼";
                                    }
                                }
                                return;
                            }
        
                            let logMessage = decoder.decode(value, { stream: true }).trim();
        
                            if (logMessage.startsWith("{") && logMessage.endsWith("}")) {
                                try {
                                    let parsedData = JSON.parse(logMessage);
                                    console.log("ğŸ“© æ”¶åˆ° JSON æ•°æ®:", parsedData);
        
                                    if (parsedData.hasOwnProperty("majorCode")) {
                                        gpaSummaryData = parsedData;
                                        hasReceivedValidData = true; // æ”¶åˆ°æœ‰æ•ˆæ•°æ®
                                    } else {
                                        gpaData.push(parsedData);
                                        renderGpaTable([parsedData]);
                                        updateProgress();
                                        hasReceivedValidData = true; // æ”¶åˆ°æœ‰æ•ˆæ•°æ®
                                    }
                                } catch (e) {
                                    console.error("âŒ JSON è§£æå¤±è´¥:", logMessage);
                                }
                            } else {
                                // å­˜å‚¨æœ€åä¸€æ¡é JSON æ•°æ®
                                lastNonJsonMessage = logMessage;
                                loadingText.innerText = logMessage;
                                updateProgress(logMessage);
                            }
        
                            read(); // ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªæ•°æ®å—
                        });
                    }
        
                    read(); // å¯åŠ¨æµå¼è¯»å–
                })
                .catch(error => {
                    // è¯·æ±‚å¤±è´¥æ—¶ï¼Œè®¾ç½®è¿›åº¦æ¡ä¸º 100% å¹¶æ˜¾ç¤ºé”™è¯¯
                    loadingText.innerText = lastNonJsonMessage || "âŒ è·å–æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•ï¼"; // æ˜¾ç¤ºæœ€åä¸€æ¡é JSON æ•°æ®
                    progress.style.width = "100%";  // ç›´æ¥è·³åˆ° 100%
                    progress.classList.add("error");
                    progressContainer.style.display = "block"; // ç¡®ä¿æ˜¾ç¤ºè¿›åº¦æ¡
                });
        }


        
        
        // âœ… æ›´æ–°è¿›åº¦æ¡
        function updateProgress(message = "") {
            if (message.includes("å¤±è´¥")) {
                progress.style.width = "100%";
                progress.classList.add("error");
            } else if (message.includes("ï¼ˆ1/4ï¼‰")) {
                progress.style.width = "25%";
            } else if (message.includes("ï¼ˆ2/4ï¼‰")) {
                progress.style.width = "50%";
            } else if (message.includes("ï¼ˆ3/4ï¼‰")) {
                progress.style.width = "75%";
            } else if (message.includes("ï¼ˆ4/4ï¼‰")) {
                progress.style.width = "100%";
            }
        }
        
        // âœ… æ¸²æŸ“ GPA è¯¾ç¨‹æ•°æ®åˆ°è¡¨æ ¼
        function renderGpaTable(data) {
            const gpaTableBody = document.getElementById("gpa-table-body");
        
            data.forEach(entry => {
                let row = document.createElement("tr");
                row.innerHTML = `
                    <td>${entry.year}</td>
                    <td>${entry.sem}</td>
                    <td>${entry.code}</td>
                    <td>${entry.section_code}</td>
                    <td>${entry.english_name}</td>
                    <td>${entry.chinese_name}</td>
                    <td>${entry.final_grade_numeric}</td>
                    <td>${entry.gpa}</td>
                    <td>${entry.credit}</td>
                `;
                gpaTableBody.appendChild(row);
            });
        }
        
        // âœ… æ¸²æŸ“ GPA æ€»è§ˆæ•°æ®
        function renderGpaSummary(data) {
            document.getElementById("major-code").textContent = data.majorCode;
            document.getElementById("major-name").textContent = data.majorName;
            document.getElementById("total-credits").textContent = data.totalCredits;
            document.getElementById("completed-credits").textContent = data.completedCredits;
            document.getElementById("remaining-credits").textContent = data.remainingCredits;
            document.getElementById("final-gpa").textContent = data.currentGpa.toFixed(2);
        
            const requiredGpaList = document.getElementById("required-gpa-list");
            requiredGpaList.innerHTML = "";
            for (let target in data.requiredGpas) {
                let listItem = document.createElement("li");
                listItem.classList.add("required-gpa-item");
        
                if (data.requiredGpas[target] === "ä¸å¯è¾¾åˆ°") {
                    listItem.classList.add("gpa-unreachable"); // çº¢è‰²
                } else {
                    listItem.classList.add("gpa-reachable"); // ç»¿è‰²
                }
        
                listItem.innerHTML = `è¾¾åˆ° ${target} æ‰€éœ€ GPA: <span>${data.requiredGpas[target]}</span>`;
                requiredGpaList.appendChild(listItem);
            }
            
            // æ¸²æŸ“ GPA æŠ˜çº¿å›¾
            renderGpaLineChart(data.GPAChart);
        }
        
        function renderGpaLineChart(semesterGpa) {
            const ctx = document.getElementById("gpa-line-chart").getContext("2d");
        
            // å¤„ç†æŠ˜çº¿å›¾æ‰€éœ€çš„æ•°æ®
            const labels = semesterGpa.map(entry => `${entry.chinese_name}`);
            const gpaValues = semesterGpa.map(entry => entry.gpa);
        
            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'GPA è¶‹åŠ¿',
                    data: gpaValues,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.4
                }]
            };
        
            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'è¯¾ç¨‹åç§°'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'GPA'
                            },
                            min: 0,
                            max: 4.0
                        }
                    }
                }
            };
        
            // åˆ›å»ºå›¾è¡¨
            new Chart(ctx, config);
        }

        
        // âœ… å¯åŠ¨ GPA è·å–æµç¨‹
        fetchGPA();

    </script>
</body>
</html>
